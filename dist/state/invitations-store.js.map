{"version":3,"file":"invitations-store.js","sourceRoot":"","sources":["../../src/state/invitations-store.ts"],"names":[],"mappings":"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","sourcesContent":["import { CellClient } from '@holochain-open-dev/cell-client';\nimport {\n  AgentPubKeyB64,\n  EntryHashB64,\n  Dictionary,\n  serializeHash,\n} from '@holochain-open-dev/core-types';\nimport { ProfilesStore } from '@holochain-open-dev/profiles';\nimport { writable, Writable, derived, get } from 'svelte/store';\n\nimport { InvitationsService } from '../invitations-service';\n\nimport { Invitation, InvitationEntryInfo } from '../types';\nimport { sleep } from '../utils';\nimport { getAllAgentsFor, isInvitationCompleted } from './selectors';\n\nexport interface InvitationsConfig {\n  clearOnInvitationComplete: boolean;\n}\n\nexport class InvitationsStore {\n  private invitations: Writable<Dictionary<InvitationEntryInfo>> = writable({});\n\n  public pendingInvitations = derived(this.invitations, invitations => {\n    const pending: Dictionary<InvitationEntryInfo> = {};\n\n    for (const [hash, info] of Object.entries(invitations)) {\n      if (!isInvitationCompleted(invitations[hash])) {\n        pending[hash] = info;\n      }\n    }\n\n    return pending;\n  });\n\n  invitationsService: InvitationsService;\n\n  constructor(\n    protected cellClient: CellClient,\n    public profilesStore: ProfilesStore,\n    public config: InvitationsConfig = {\n      clearOnInvitationComplete: false,\n    }\n  ) {\n    this.invitationsService = new InvitationsService(cellClient);\n    this.invitationsService.cellClient.addSignalHandler(s =>\n      this.signalHandler(s)\n    );\n  }\n\n  invitationInfo(invitationHash: EntryHashB64) {\n    return derived(\n      this.invitations,\n      invitations => invitations[invitationHash]\n    );\n  }\n\n  get myAgentPubKey() {\n    return serializeHash(this.invitationsService.cellClient.cellId[1]);\n  }\n\n  public async fetchMyPendingInvitations(): Promise<void> {\n    // Pedir al backend\n    const pending_invitations_entries_info: InvitationEntryInfo[] =\n      await this.invitationsService.getMyPendingInvitations();\n\n    const promises = pending_invitations_entries_info.map(i =>\n      this.fetchProfilesForInvitation(i.invitation)\n    );\n    await Promise.all(promises);\n\n    this.invitations.update(invitations => {\n      pending_invitations_entries_info.map(invitation_entry_info => {\n        invitations[invitation_entry_info.invitation_entry_hash] =\n          invitation_entry_info;\n      });\n      return invitations;\n    });\n  }\n\n  public async sendInvitation(inviteesList: AgentPubKeyB64[]) {\n    const create_invitation = await this.invitationsService.sendInvitation(\n      inviteesList\n    );\n\n    await this.fetchMyPendingInvitations();\n  }\n\n  async acceptInvitation(invitation_entry_hash: EntryHashB64, retryCount = 5) {\n    if (retryCount === 0) {\n      return\n    }\n    try {\n      const accept_invitation = await this.invitationsService.acceptInvitation(\n        invitation_entry_hash\n      );\n    } catch(e){\n      console.log(\"waiting 2 seconds for network to synch\")\n      await sleep(2000)\n      return new Promise((resolve) => {resolve(this.acceptInvitation(invitation_entry_hash, retryCount-1))})\n    }\n\n    return new Promise(resolve => {\n      this.invitations.update(invitations => {\n        const invitationInfo = invitations[invitation_entry_hash];\n        invitationInfo.invitees_who_accepted.push(this.myAgentPubKey);\n\n        if (\n          this.config.clearOnInvitationComplete &&\n          isInvitationCompleted(invitationInfo)\n        ) {\n          this.clearInvitation(invitation_entry_hash).then(() => resolve(null));\n        } else {\n          resolve(null);\n        }\n        return invitations;\n      });\n    });\n  }\n\n  async rejectInvitation(invitation_entry_hash: EntryHashB64, retryCount = 5) {\n    if (retryCount === 0) {\n      return\n    }\n    try {\n      const reject_invitation = await this.invitationsService.rejectInvitation(\n        invitation_entry_hash\n      );\n    } catch(e){\n      //if e = entry hash not found\n      console.log(\"waiting 2 seconds for network to synch\")\n      await sleep(2000)\n      return new Promise((resolve) => {resolve(this.rejectInvitation(invitation_entry_hash, retryCount-1))})\n    }\n    this.invitations.update(invitations => {\n      delete invitations[invitation_entry_hash];\n      return invitations;\n    });\n  }\n\n  async clearInvitation(invitation_entry_hash: EntryHashB64) {\n    await this.invitationsService.clearInvitation(invitation_entry_hash);\n\n    this.invitations.update(invitations => {\n      delete invitations[invitation_entry_hash];\n      return invitations;\n    });\n  }\n\n  async fetchProfilesForInvitation(\n    invitation: Invitation,\n    retryCount = 4\n  ): Promise<void> {\n    if (retryCount === 0) {\n      return;\n    }\n\n    const agents = getAllAgentsFor(invitation);\n    await this.profilesStore.fetchAgentsProfiles(agents);\n\n    const knownProfiles = get(this.profilesStore.knownProfiles);\n\n    if (agents.some(agent => !knownProfiles[agent])) {\n      await sleep(1500);\n\n      return this.fetchProfilesForInvitation(invitation, retryCount - 1);\n    }\n  }\n\n  async invitationReceived(signal: any) {\n    const invitation = signal.payload.InvitationReceived;\n\n    await this.fetchProfilesForInvitation(invitation.invitation);\n\n    this.invitations.update(invitations => {\n      invitations[invitation.invitation_entry_hash] = invitation;\n      return invitations;\n    });\n  }\n\n  async invitationAccepted(signal: any) {\n    const invitation = signal.payload.InvitationAccepted;\n    this.invitations.update(invitations => {\n      invitations[invitation.invitation_entry_hash] = invitation;\n      return invitations;\n    });\n\n    if (\n      this.config.clearOnInvitationComplete &&\n      isInvitationCompleted(invitation)\n    ) {\n      await this.clearInvitation(invitation.invitation_entry_hash);\n    }\n  }\n\n  invitationRejected(signal: any) {\n    const invitation = signal.payload.InvitationRejected;\n\n    this.invitations.update(invitations => {\n      invitations[invitation.invitation_entry_hash] = invitation;\n      return invitations;\n    });\n  }\n\n  async signalHandler(signal: any) {\n    switch (signal.data.payload.name) {\n      case 'invitation received':\n        this.invitationReceived(signal.data.payload);\n        break;\n\n      case 'invitation accepted':\n        this.invitationAccepted(signal.data.payload);\n        break;\n\n      case 'invitation updated':\n        break;\n\n      case 'invitation rejected':\n        this.invitationRejected(signal.data.payload);\n        break;\n\n      default:\n        break;\n    }\n  }\n}\n"]}